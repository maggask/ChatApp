var app=angular.module("ChatApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html",controller:"LoginController"}).when("/room/:roomName",{templateUrl:"templates/room.html",controller:"RoomController"}).when("/rooms/",{templateUrl:"templates/rooms.html",controller:"RoomsController"}).otherwise({redirectTo:"/"})}]),app.factory("SocketService",["$http",function(){var a="",b=null;return{setConnected:function(a){b=a},setUsername:function(b){a=b},getUsername:function(){return a},getSocket:function(){return null===b&&this.connect(),b},connect:function(){b=io.connect("http://localhost:8080")}}}]),app.controller("LoginController",["$scope","$location","SocketService",function(a,b,c){a.username="",a.message="";var d=c.getSocket();a.connect=function(){d&&d.emit("adduser",a.username,function(e){e?(c.setConnected(d),c.setUsername(a.username),b.path("/rooms")):a.message="Your name is taken, please choose another",a.$apply()})},a.keyPress=function(b){13===b.keyCode&&a.connect()}}]),app.controller("RoomController",["$scope","$routeParams","$location","SocketService",function(a,b,c,d){a.roomName=b.roomName,a.currentMessage="",a.privateMessage="",a.pmMessages=[];var e=d.getSocket();e&&(e.emit("joinroom",{room:a.roomName,pass:""},function(){}),e.on("updatechat",function(b,c){console.log(c),a.messages=c,document.getElementById("messages").scrollTop=1e6,a.$apply()}),e.on("updateusers",function(b,c){b===a.roomName&&(a.users=c),a.$apply()}),e.on("kicked",function(b,e){d.getUsername()===e?(console.log("You were kicked from the room"),c.path("/rooms"),a.$apply()):console.log(d.getUsername()+" kicked "+e)}),e.on("banned",function(b,e){d.getUsername()===e?(console.log("You were banned from the room"),c.path("/rooms"),a.$apply()):console.log(d.getUsername()+" banned "+e)}),e.on("recv_privatemsg",function(b,c){console.log("privatemessage"),console.log(b+": "+c);var d={Sender:b,Message:c};a.pmMessages.push(d),a.$apply()}),a.send=function(){var b=[],c="";"/Kick"===a.currentMessage.substring(0,5)?(b=a.currentMessage.split(" "),c=b[1],e.emit("kick",{user:c,room:a.roomName,pass:""},function(){})):"/Ban"===a.currentMessage.substring(0,4)?(b=a.currentMessage.split(" "),c=b[1],e.emit("ban",{user:c,room:a.roomName,pass:""},function(){})):(console.log("I sent a message to "+a.roomName+": "+a.currentMessage),e.emit("sendmsg",{roomName:a.roomName,msg:a.currentMessage})),a.currentMessage=""},a.keyPress=function(b,c){13===b.keyCode&&(c===a.currentMessage?a.send():c===a.privateMessage&&a.sendPm())},a.quit=function(b,d){console.log("I left the room "+d),e.emit("partroom",d),e.on("updateusers",function(b,c){b===a.roomName&&(a.users=c,a.$apply())}),c.path("/rooms")},a.sendPm=function(b){return e.emit("privatemsg",{nick:b,message:a.privateMessage,pass:""},function(){}),console.log("I send a private message to "+b),a.privateMessage="",!1},a.isMe=function(a){return a===d.getUsername()})}]),app.controller("RoomsController",["$scope","$location","SocketService",function(a,b,c){var d=c.getSocket();a.roomlist=[],d&&(d.emit("rooms"),d.on("roomlist",function(b){a.roomlist=[];for(var c in b)a.roomlist.push(c);a.$apply()}),a.create=function(){console.log("I created a new room "+a.roomname),void 0===a.roomname?a.message="You have to choose a name for your room!":(d.emit("joinroom",{room:a.roomname,pass:""},function(){}),d.on("updateusers",function(b,c){b===a.roomName&&(a.users=c),a.$apply()}),b.path("/room/"+a.roomname))},a.enter=function(c){console.log("I entered an existing room "+c),d.emit("joinroom",{room:c,pass:""},function(c){console.log(c),c===!1&&(b.path("/rooms"),a.$apply(),console.log("You were banned from this room, you can not re-enter!"))}),b.path("/room/"+c)},a.keyPress=function(b){13===b.keyCode&&a.create()})}]);